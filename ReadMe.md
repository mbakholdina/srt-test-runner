# Testing Scripts Usage

## Requirements

* python 3.6+
* cmake 3.1+
* tshark


### Setting up TShark

The following steps are valid fo Ubuntu 18. Fo other platforms perform similar steps.

```
sudo apt-get install tshark
```

When asked whether to allow members of the wireshark group to capture packets on network
interfaces, answer `<Yes>`. This will allow to run `tshark` without elevated privileges. See section I./b. [Installing dumpcap and allowing non-root users to capture packets](https://wiki.wireshark.org/CaptureSetup/CapturePrivileges).


Finally add the user to wireshark group.
```
sudo usermod -a -G wireshark {username}
```

A logout is required for the changes to be applyed.

#### CentOS 7

```
whereis tshark
sudo setcap cap_net_raw,cap_net_admin+eip /usr/local/bin/tshark
sudo setcap cap_net_raw,cap_net_admin+eip /usr/local/bin/dumpcap
sudo setcap cap_net_raw,cap_net_admin+eip /usr/sbin/tshark
sudo setcap cap_net_raw,cap_net_admin+eip /usr/sbin/dumpcap
```


### <a name="building"></a> Building a Testing Application

`srt-test-messaging` application is used for the tests.
```
mkdir _build && cd _build
cmake ../ -DENABLE_MESSAGING_LIB=ON -DENABLE_TESTING=ON
cmake --build ./
```


# 1. Bandwidth Loop Test

Script `test-messaging-bw-loop.py` runs a bandwidth loop test. Testing application 
`srt-test-messaging` is used to produce data with specified bitrates to send it over the network.
The scripts loops through several sending bitrates, starting with 50 Mbps. The amount of packets to be sent is calculated based on the specified bitrate and the specified duration of the experiment. The duration of each run is 20 seconds.

`tshark` is started in a separate process to capture network traffic. At the same time the testing application write SRT core statistics to the specified CSV file.

The script measures the time spent by the application to transmit the generated amoung of data packets. If the time spent exceeds 25 seconds, the last used bitrate is considerd to be the available bandwidth. of the network link.

## SRT configuration
* Congestion control:   live
* Message size:         1456
* Sending buffer:   12058624
* Receiving buffer: 12058624

## Running the Script

All further commands are called from the `_build` folder. See section [Building a Testing Application](#building).

### Sender

The following command line will start the sending script.

```
python3 ../scripts/python/test-messaging-bw-loop.py <dst_ip> <dst_port> <srt_desc> <pcapng_prefix> <nw_iface> --collect-stats
 ```

An example command line for `srt-test-messaging`, generated by the script, will look like this:
```
./srt-test-messaging "srt://192.168.0.7:4200?sndbuf=12058624&smoother=live&maxbw=40000000" "" -bitrate 100000000 -msgsize 1456 -reply 0 -repeat 250000 -printmsg 0 -statsfile filename.csv -statsfreq 1
```

### Receiver
```
./srt-test-messaging "srt://:4200?rcvbuf=12058624&smoother=live" -reply 0 -msgsize 1456 -printmsg 0
```

## Points of Analysis

* Loss ratio at each sending rate.
* Sending rate deviation on 10 ms intervals from average sending rate on 1 sec. In this test case the sending rate of SRT should be constant and should not depend on congestion control. Therefore it is a good point to analyze the accuracy.
* Actual bandwidth estimation of the link.

  
# 2. Congestion Controled Transfer (8 MB messages)

Script `test-messaging-filecc-loop.py` runs a congestion controled transfer test.
Testing application `srt-test-messaging` is used to produce data as fast as possible, and to send it over the network.

The script estimates how many packets have to be produced for the test to take 2 minutes with estimated bandwidth of 500 Mbps. Experiment is run several times to get reproducable results.

`tshark` is started in a separate process to capture network traffic. At the same time the testing application write SRT core statistics to the specified CSV file.

One message: `8MB = 8388608` bytes of payload. This data can be transferred with 5762 packets with maximum payload size 1456. The actual data size transmitted will be `8643000` bytes (`+3%`).
With 1 Gbps there will be 14 packets per second (actual 10).

## SRT configuration

* Congestion control: file
* Message size: 8 MB
* Default buffer size: `42411312` bytes (`5 * (message_size * 1472 / 1456 + 1472)`)

## Running the Script

All further commands are called from the `_build` folder. See section [Building a Testing Application](#building).

### Sender
```
python3 ../scripts/python/test-messaging-filecc-loop.py 13.95.221.109 4200 istd-0-sleep-0 azuswest-to-azeuwest
```

```
./srt-test-messaging "srt://192.168.0.110:4200" "" -reply 0 -repeat 2200 -printmsg 0
```
### Receiver
```
./srt-test-messaging "srt://:4200" -reply 0 -printmsg 0
```